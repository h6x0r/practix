################################################################################
# Practix Main Stack
# Usage: docker compose up -d
################################################################################

services:
  ##############################################################################
  # PostgreSQL Database
  ##############################################################################
  db:
    image: postgres:15-alpine
    container_name: practix_postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: practix_user
      POSTGRES_PASSWORD: practix_secure_password
      POSTGRES_DB: practix_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U practix_user -d practix_db"]
      interval: 5s
      timeout: 5s
      retries: 6
      start_period: 10s

  ##############################################################################
  # Redis for BullMQ Queue
  # SECURITY: Password protected, port not exposed in production
  ##############################################################################
  redis:
    image: redis:7-alpine
    container_name: practix_redis
    restart: unless-stopped
    command: >
      redis-server
      --maxmemory 1gb
      --maxmemory-policy noeviction
      --appendonly yes
    # NOTE: Remove port exposure in production - only internal access
    # For local development, you can uncomment this:
    # ports:
    #   - "127.0.0.1:6379:6379"
    volumes:
      - redis_data:/data
    # Container memory limits
    mem_limit: 1200m # Slightly more than maxmemory to allow for overhead
    memswap_limit: 1200m
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  ##############################################################################
  # Judge0 Code Execution Engine
  # Fast, reliable code execution with native ARM64 support
  # Docs: https://github.com/judge0/judge0
  ##############################################################################
  judge0-server:
    image: judge0/judge0:1.13.1
    container_name: practix_judge0
    restart: always
    ports:
      - "2358:2358"
    privileged: true
    # Required for isolate on Docker Desktop (macOS/Windows)
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    tmpfs:
      - /box:exec,size=512M
      - /tmp:exec,size=512M
    environment:
      # Database (uses separate postgres for Judge0)
      - POSTGRES_HOST=judge0-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=judge0
      - POSTGRES_USER=judge0
      - POSTGRES_PASSWORD=judge0_secure_password
      # Redis (uses separate redis for Judge0)
      - REDIS_HOST=judge0-redis
      - REDIS_PORT=6379
      # Judge0 Configuration
      - ENABLE_WAIT_RESULT=true
      - ENABLE_BATCHED_SUBMISSIONS=true
      - MAX_QUEUE_SIZE=100
      - CPU_TIME_LIMIT=15
      - CPU_EXTRA_TIME=5
      - WALL_TIME_LIMIT=20
      - MEMORY_LIMIT=512000
      - STACK_LIMIT=64000
      - MAX_PROCESSES_AND_OR_THREADS=60
      - ENABLE_PER_PROCESS_AND_THREAD_TIME_LIMIT=false
      - ENABLE_PER_PROCESS_AND_THREAD_MEMORY_LIMIT=false
      - MAX_FILE_SIZE=2048
      - NUMBER_OF_RUNS=1
      - ENABLE_NETWORK=false
      # SECURITY NOTE: Memory limit is disabled for Docker Desktop (macOS/Windows)
      # because cgroups don't work properly. In production (Coolify), memory limits ARE enforced.
      # See docker-compose.coolify.yml for production settings.
      - DISABLE_MEMORY_LIMIT=true
    depends_on:
      judge0-db:
        condition: service_healthy
      judge0-redis:
        condition: service_healthy
    mem_limit: 2g
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:2358/languages"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  judge0-workers:
    image: judge0/judge0:1.13.1
    container_name: practix_judge0_workers
    restart: always
    command: ["./scripts/workers"]
    privileged: true
    # Required for isolate on Docker Desktop (macOS/Windows)
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
    security_opt:
      - seccomp:unconfined
      - apparmor:unconfined
    tmpfs:
      - /box:exec,size=512M
      - /tmp:exec,size=512M
    environment:
      - POSTGRES_HOST=judge0-db
      - POSTGRES_PORT=5432
      - POSTGRES_DB=judge0
      - POSTGRES_USER=judge0
      - POSTGRES_PASSWORD=judge0_secure_password
      - REDIS_HOST=judge0-redis
      - REDIS_PORT=6379
      - ENABLE_WAIT_RESULT=true
      - CPU_TIME_LIMIT=15
      - CPU_EXTRA_TIME=5
      - WALL_TIME_LIMIT=20
      - MEMORY_LIMIT=512000
      - NUMBER_OF_RUNS=1
      # SECURITY NOTE: See comment above in judge0-server section
      - DISABLE_MEMORY_LIMIT=true
    depends_on:
      judge0-server:
        condition: service_healthy
    mem_limit: 4g

  judge0-db:
    image: postgres:15-alpine
    container_name: practix_judge0_db
    restart: unless-stopped
    environment:
      POSTGRES_USER: judge0
      POSTGRES_PASSWORD: judge0_secure_password
      POSTGRES_DB: judge0
    volumes:
      - judge0_postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U judge0 -d judge0"]
      interval: 5s
      timeout: 5s
      retries: 6
      start_period: 10s

  judge0-redis:
    image: redis:7-alpine
    container_name: practix_judge0_redis
    restart: unless-stopped
    command: redis-server --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - judge0_redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  ##############################################################################
  # Backend API Server
  ##############################################################################
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://practix_user:practix_secure_password@db:5432/practix_db?schema=public&connection_limit=20&pool_timeout=10
      JWT_SECRET: ${JWT_SECRET:-super_secret_jwt_key_practix_v1_production_ready_2025}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      PORT: 8080
      SKIP_SEED: ${SKIP_SEED:-false}
      NODE_ENV: ${NODE_ENV:-production}
      # Judge0 Configuration
      JUDGE0_URL: http://judge0-server:2358
      # Redis Configuration
      REDIS_HOST: redis
      REDIS_PORT: 6379
      # Security Configuration
      ENABLE_IP_BAN: ${ENABLE_IP_BAN:-true}
      SUSPICIOUS_ACTIVITY_LOG: ${SUSPICIOUS_ACTIVITY_LOG:-true}
      MALICIOUS_CODE_CHECK: ${MALICIOUS_CODE_CHECK:-true}
      IP_BAN_THRESHOLD: ${IP_BAN_THRESHOLD:-10}
      IP_BAN_DURATION_HOURS: ${IP_BAN_DURATION_HOURS:-24}
      # Rate Limiting (RUN limits are in SECONDS between runs, AUTH limits are requests/min)
      RATE_LIMIT_RUN_FREE: ${RATE_LIMIT_RUN_FREE:-10}
      RATE_LIMIT_RUN_AUTH: ${RATE_LIMIT_RUN_AUTH:-10}
      RATE_LIMIT_RUN_PREMIUM: ${RATE_LIMIT_RUN_PREMIUM:-5}
      RATE_LIMIT_REGISTER: ${RATE_LIMIT_REGISTER:-3}
      RATE_LIMIT_LOGIN: ${RATE_LIMIT_LOGIN:-5}
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      judge0-server:
        condition: service_healthy
    command: >
      sh -c "until npx prisma db push; do echo 'Waiting for Postgres...'; sleep 5; done &&
      if [ \"$SKIP_SEED\" != \"true\" ]; then npm run seed || true; fi &&
      node dist/main"

  ##############################################################################
  # Frontend
  ##############################################################################
  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:8080}
        GEMINI_API_KEY: ${GEMINI_API_KEY:-}
    depends_on:
      - backend
    ports:
      - "3000:80"
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  judge0_postgres_data:
  judge0_redis_data:
