################################################################################
# KODLA Main Stack
# Usage: docker compose up -d
################################################################################

services:
  ##############################################################################
  # PostgreSQL Database
  ##############################################################################
  db:
    image: postgres:15-alpine
    container_name: kodla_postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: kodla_user
      POSTGRES_PASSWORD: kodla_secure_password
      POSTGRES_DB: kodla_db
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kodla_user -d kodla_db"]
      interval: 5s
      timeout: 5s
      retries: 6
      start_period: 10s

  ##############################################################################
  # Redis for BullMQ Queue
  # SECURITY: Password protected, port not exposed in production
  ##############################################################################
  redis:
    image: redis:7-alpine
    container_name: kodla_redis
    restart: unless-stopped
    command: >
      redis-server
      --maxmemory 1gb
      --maxmemory-policy allkeys-lru
      --appendonly yes
      --requirepass ${REDIS_PASSWORD:-kodla_redis_secure_password_2025}
    # NOTE: Remove port exposure in production - only internal access
    # For local development, you can uncomment this:
    # ports:
    #   - "127.0.0.1:6379:6379"
    volumes:
      - redis_data:/data
    # Container memory limits
    mem_limit: 1200m  # Slightly more than maxmemory to allow for overhead
    memswap_limit: 1200m
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD:-kodla_redis_secure_password_2025}", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  ##############################################################################
  # Piston Code Execution Engine
  # Note: On ARM64 (Apple Silicon), Piston runs under Rosetta emulation
  # and requires privileged mode for proper isolation
  #
  # For ML courses setup, see: docs/PISTON_ML_SETUP.md
  ##############################################################################
  piston:
    image: ghcr.io/engineer-man/piston
    container_name: kodla_piston
    restart: always  # Auto-restart on crash or OOM
    privileged: true
    ports:
      - "2000:2000"
    volumes:
      - piston_data:/piston/jobs
      - piston_packages:/piston/packages
    # Memory limits - increased for ML courses (NumPy, Pandas, sklearn)
    mem_limit: 2g
    memswap_limit: 2g  # No swap, strict limit
    environment:
      - PISTON_RUN_TIMEOUT=30000     # 30s for ML training tasks
      - PISTON_COMPILE_TIMEOUT=30000
      - PISTON_OUTPUT_MAX_SIZE=131072  # 128KB for chart JSON output
      - PISTON_MAX_PROCESS_COUNT=64  # Reduced for memory efficiency
      - PISTON_MAX_OPEN_FILES=2048   # Reduced for memory efficiency
      - PISTON_MAX_FILE_SIZE=10485760
      - PISTON_PROCESS_LIMIT=64      # Reduced for memory efficiency
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:2000/api/v2/runtimes', (r) => process.exit(r.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  ##############################################################################
  # Backend API Server
  ##############################################################################
  backend:
    build:
      context: ./server
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      DATABASE_URL: postgresql://kodla_user:kodla_secure_password@db:5432/kodla_db?schema=public&connection_limit=20&pool_timeout=10
      JWT_SECRET: ${JWT_SECRET:-super_secret_jwt_key_kodla_v1_production_ready_2025}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      PORT: 8080
      SKIP_SEED: ${SKIP_SEED:-false}
      NODE_ENV: ${NODE_ENV:-production}
      # Piston Configuration
      PISTON_URL: http://piston:2000
      # Redis Configuration (with password)
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD:-kodla_redis_secure_password_2025}
      # Security Configuration
      ENABLE_IP_BAN: ${ENABLE_IP_BAN:-true}
      SUSPICIOUS_ACTIVITY_LOG: ${SUSPICIOUS_ACTIVITY_LOG:-true}
      MALICIOUS_CODE_CHECK: ${MALICIOUS_CODE_CHECK:-true}
      IP_BAN_THRESHOLD: ${IP_BAN_THRESHOLD:-5}
      IP_BAN_DURATION_HOURS: ${IP_BAN_DURATION_HOURS:-24}
      # Rate Limiting
      RATE_LIMIT_RUN_FREE: ${RATE_LIMIT_RUN_FREE:-10}
      RATE_LIMIT_RUN_AUTH: ${RATE_LIMIT_RUN_AUTH:-10}
      RATE_LIMIT_RUN_PREMIUM: ${RATE_LIMIT_RUN_PREMIUM:-5}
    ports:
      - "8080:8080"
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_healthy
      piston:
        condition: service_healthy
    command: >
      sh -c "until npx prisma db push; do echo 'Waiting for Postgres...'; sleep 5; done &&
      if [ \"$SKIP_SEED\" != \"true\" ]; then npm run seed || true; fi &&
      node dist/main"

  ##############################################################################
  # Frontend
  ##############################################################################
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:8080}
        GEMINI_API_KEY: ${GEMINI_API_KEY:-}
    depends_on:
      - backend
    ports:
      - "3000:80"
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:
  piston_data:
  piston_packages:
