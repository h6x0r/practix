generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
}

// Task type for different submission flows
enum TaskType {
  CODE    // Traditional code tasks (executed by Piston)
  PROMPT  // Prompt engineering tasks (evaluated by AI)
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String
  avatarUrl String?
  isPremium Boolean  @default(false)
  role      UserRole @default(USER)
  isBot     Boolean  @default(false) // Demo/seed users for analytics display

  // Subscription plan details { name: string, expiresAt: string }
  plan Json?

  // Editor and notification preferences
  preferences Json?

  // Roadmap generation tracking (first generation is free)
  roadmapGenerations     Int       @default(0)
  lastRoadmapGeneration  DateTime?

  // === GAMIFICATION ===
  xp             Int      @default(0)     // Total experience points
  level          Int      @default(1)     // Current level (1-100)
  currentStreak  Int      @default(0)     // Current daily streak
  maxStreak      Int      @default(0)     // Longest streak ever
  lastActivityAt DateTime?               // Last task completion date (for streak)

  // === BAN SYSTEM ===
  isBanned     Boolean   @default(false)
  bannedAt     DateTime?
  bannedReason String?
  bannedBy     String?   // Admin user ID who performed the ban

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  submissions      Submission[]
  roadmaps         UserRoadmap[]
  aiUsage          AiUsage[]
  bugReports       BugReport[]
  subscriptions    Subscription[]
  purchases        Purchase[]
  badges           UserBadge[]
  courses          UserCourse[]
  sessions         Session[]
  taskCompletions  TaskCompletion[]
  runResults       RunResult[]
  courseAccesses   CourseAccess[]

  // Performance indexes for leaderboard and gamification queries
  @@index([level, xp])        // Leaderboard sorting
  @@index([xp])               // XP-based rankings
  @@index([currentStreak])    // Streak leaderboard
  @@index([isBanned])         // Quick banned users lookup
}

model Course {
  id            String @id @default(uuid())
  slug          String @unique // e.g. "c_go"
  category      String // 'language', 'cs', 'interview'
  title         String
  description   String
  icon          String
  estimatedTime String
  order         Int    @default(0)

  // Multi-language: { ru: { title, description }, uz: {...} }
  translations  Json?

  modules           Module[]
  subscriptionPlans SubscriptionPlan[]
  courseAccesses    CourseAccess[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Module {
  id            String  @id @default(uuid())
  courseId      String
  title         String
  description   String
  section       String? // 'core', 'frameworks', etc.
  estimatedTime String  @default("1h") // Calculated from sum of task times during seed
  order         Int

  // Multi-language: { ru: { title, description }, uz: {...} }
  translations Json?

  course Course  @relation(fields: [courseId], references: [id], onDelete: Cascade)
  topics Topic[]
}

model Topic {
  id            String @id @default(uuid())
  moduleId      String
  title         String
  description   String
  difficulty    String // 'easy', 'medium', 'hard'
  estimatedTime String
  order         Int

  // Multi-language: { ru: { title, description }, uz: {...} }
  translations  Json?

  module Module @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  tasks  Task[]
}

model Task {
  id            String   @id @default(uuid())
  topicId       String? // Optional for backward compatibility, but required for structured courses
  slug          String   @unique
  title         String   // User-friendly title (EN default)
  description   String   // Task description with examples (EN default)
  difficulty    String
  tags          String[]
  isPremium     Boolean  @default(false)
  isImportant   Boolean  @default(false) // UI annotation for important GoF patterns
  initialCode   String
  solutionCode  String?
  solutionExplanation String? // Solution with line-by-line comments explaining the code
  whyItMatters  String? // 1-2 paragraphs explaining real-world usage and importance of this pattern
  testCode      String? // Test code for task validation
  hint1         String? // First hint (gentle nudge, 8-10 words)
  hint2         String? // Second hint (more detailed, 8-10 words)
  estimatedTime String
  youtubeUrl    String?
  order         Int      @default(0)

  // Task type: CODE (default) or PROMPT (for prompt engineering)
  taskType      TaskType @default(CODE)

  // ML visualization support
  visualizationType String? // 'none' | 'line' | 'bar' | 'scatter' | 'heatmap' | 'confusion_matrix' | 'multi'

  // Prompt Engineering configuration (only for taskType: PROMPT)
  // Structure: { testScenarios: [...], judgePrompt: string, passingScore: number }
  promptConfig  Json?

  // Multi-language support: { ru: { title, description, hint1, hint2, solutionExplanation, whyItMatters }, uz: {...} }
  translations  Json?

  topic           Topic?           @relation(fields: [topicId], references: [id], onDelete: Cascade)
  submissions     Submission[]
  bugReports      BugReport[]
  taskCompletions TaskCompletion[]
  runResults      RunResult[]
}

model Submission {
  id          String   @id @default(uuid())
  userId      String
  taskId      String
  status      String
  score       Int
  runtime     String
  memory      String?
  code        String
  message     String?
  testsPassed Int?
  testsTotal  Int?
  testCases   Json?     // Array of test case results for UI display
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@index([userId, status])
  @@index([userId, taskId])
  @@index([taskId, status])
  @@index([createdAt])
  // Additional indexes for performance
  @@index([taskId])              // For task-only queries
  @@index([status])              // For status-only filters
  @@index([userId, createdAt])   // For user's recent submissions
}

// Stores the latest Run Code result for each user+task pair (UPSERT)
// This allows persisting quick test results across page reloads
model RunResult {
  id          String   @id @default(uuid())
  userId      String
  taskId      String
  status      String   // 'passed' | 'failed' | 'error'
  testsPassed Int
  testsTotal  Int
  runtime     String
  message     String?
  testCases   Json?    // Array of test case results
  code        String   // The code that was run
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  // Only one RunResult per user+task pair
  @@unique([userId, taskId])
  @@index([userId])
  @@index([taskId])
}

model UserRoadmap {
  id            String   @id @default(uuid())
  userId        String
  role          String
  level         String
  title         String
  totalProgress Int      @default(0)
  phases        Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Index for efficient user lookup
  @@index([userId])
}

model AiUsage {
  id        String   @id @default(uuid())
  userId    String
  date      String // Format: YYYY-MM-DD
  count     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date])
}

model BugReport {
  id          String   @id @default(uuid())
  userId      String
  taskId      String?
  category    String   // 'description' | 'solution' | 'editor' | 'hints' | 'ai-tutor' | 'other'
  severity    String   @default("medium") // 'low' | 'medium' | 'high'
  title       String
  description String
  metadata    Json?    // { userCode?, browserInfo?, url? }
  status      String   @default("open") // 'open' | 'reviewing' | 'resolved' | 'closed'
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task? @relation(fields: [taskId], references: [id], onDelete: SetNull)
}

// Subscription plan definitions (admin-managed)
model SubscriptionPlan {
  id           String   @id @default(uuid())
  slug         String   @unique // 'global', 'go-basics', 'java-core', etc.
  name         String   // Display name
  nameRu       String?  // Russian name
  type         String   // 'global' | 'course'
  courseId     String?  // null for global plans
  priceMonthly Int      // Price in tiyn (1 UZS = 100 tiyn)
  currency     String   @default("UZS")
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  course        Course?        @relation(fields: [courseId], references: [id], onDelete: SetNull)
  subscriptions Subscription[]
}

// User subscriptions
model Subscription {
  id        String   @id @default(uuid())
  userId    String
  planId    String
  status    String   @default("active") // 'active' | 'cancelled' | 'expired' | 'pending'
  startDate DateTime @default(now())
  endDate   DateTime // subscription expiry
  autoRenew Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan     SubscriptionPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@unique([userId, planId]) // One subscription per plan per user
  @@index([userId])
  @@index([status])
  @@index([endDate])          // For active subscription queries by expiry
  @@index([userId, status])   // For user's active subscriptions
}

// Payment history (for subscription payments)
model Payment {
  id             String   @id @default(uuid())
  subscriptionId String
  amount         Int      // Amount in tiyn
  currency       String   @default("UZS")
  status         String   // 'pending' | 'completed' | 'failed' | 'refunded'
  provider       String?  // 'payme' | 'click' | null
  providerTxId   String?  // External transaction ID from provider
  metadata       Json?    // Provider-specific data
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([status])
}

// One-time purchases (roadmap generations, AI credits, course access, etc.)
model Purchase {
  id           String   @id @default(uuid())
  userId       String
  type         String   // 'roadmap_generation' | 'ai_credits' | 'course_access'
  quantity     Int      @default(1)
  amount       Int      // Amount in tiyn
  currency     String   @default("UZS")
  status       String   // 'pending' | 'completed' | 'failed' | 'refunded'
  provider     String?  // 'payme' | 'click' | null
  providerTxId String?  // External transaction ID from provider
  metadata     Json?    // Provider-specific data (order details, courseId for course_access, etc.)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([type])
}

// One-time course access (lifetime access via purchase, not subscription)
model CourseAccess {
  id         String    @id @default(uuid())
  userId     String
  courseId   String
  purchaseId String?   // Reference to the Purchase that granted this access
  expiresAt  DateTime? // null = lifetime access (never expires)
  createdAt  DateTime  @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId]) // One access per user per course
  @@index([userId])
  @@index([courseId])
}

// Payment transaction log (for all payment attempts - debugging & audit)
model PaymentTransaction {
  id             String   @id @default(uuid())
  orderId        String   // Internal order ID (subscription or purchase ID)
  orderType      String   // 'subscription' | 'purchase'
  provider       String   // 'payme' | 'click'
  providerTxId   String?  // External transaction ID
  amount         Int      // Amount in tiyn
  state          Int      // Provider-specific state code
  action         String   // 'create' | 'perform' | 'cancel' | 'check'
  request        Json?    // Raw request from provider
  response       Json?    // Raw response sent to provider
  errorCode      Int?     // Error code if failed
  errorMessage   String?  // Error message if failed
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([orderId])
  @@index([providerTxId])
  @@index([provider])
}

// === GAMIFICATION MODELS ===

// Badge definitions (seeded)
model Badge {
  id          String @id @default(uuid())
  slug        String @unique // 'first-task', 'streak-7', 'level-10', etc.
  name        String
  description String
  icon        String // Emoji or icon name
  category    String // 'milestone', 'streak', 'level', 'special'
  requirement Int    // e.g., 7 for 7-day streak, 10 for level 10
  xpReward    Int    @default(0) // Bonus XP for earning badge

  // Multi-language: { ru: { name, description }, uz: {...} }
  translations Json?

  createdAt DateTime    @default(now())
  users     UserBadge[]
}

// User-earned badges (many-to-many)
model UserBadge {
  id        String   @id @default(uuid())
  userId    String
  badgeId   String
  earnedAt  DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@unique([userId, badgeId])
  @@index([userId])
}

// === USER COURSE PROGRESS ===
// Tracks which courses a user has started and their progress
model UserCourse {
  id             String   @id @default(uuid())
  userId         String
  courseSlug     String   // Course slug (e.g., 'go-basics')
  progress       Int      @default(0) // 0-100 percentage
  startedAt      DateTime @default(now())
  lastAccessedAt DateTime @default(now())
  completedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, courseSlug])
  @@index([userId])
}

// === SESSION MANAGEMENT ===
// Multi-device auth: 1 mobile + 1 desktop allowed simultaneously

enum DeviceType {
  MOBILE
  DESKTOP
  UNKNOWN
}

model Session {
  id           String     @id @default(uuid())
  userId       String
  token        String     @unique
  deviceType   DeviceType @default(UNKNOWN)  // For per-device-type session limiting
  deviceInfo   String?    // Browser, OS info (User-Agent string)
  ipAddress    String?
  isActive     Boolean    @default(true)
  createdAt    DateTime   @default(now())
  expiresAt    DateTime
  lastActiveAt DateTime   @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([userId, deviceType])             // For per-device-type session lookup
  // Indexes for session cleanup queries
  @@index([expiresAt])                      // Expired sessions cleanup
  @@index([isActive, lastActiveAt])         // Inactive sessions cleanup
  @@index([createdAt])                      // Old sessions cleanup (30 days)
}

// === TASK COMPLETION TRACKING ===
// Tracks first successful task completions for atomic XP award
// Unique constraint prevents race condition where two parallel submissions
// could both award XP for "first completion"
model TaskCompletion {
  id        String   @id @default(uuid())
  userId    String
  taskId    String
  xpAwarded Int      // XP awarded for this completion
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  task Task @relation(fields: [taskId], references: [id], onDelete: Cascade)

  @@unique([userId, taskId]) // Only one completion per user per task
  @@index([userId])
}

// === SECURITY EVENTS ===
// Logs security-related events for auditing and analysis
model SecurityEvent {
  id        String   @id @default(uuid())
  type      String   // SecurityEventType enum value
  severity  String   // EventSeverity enum value
  ip        String
  userId    String?  // Can be null for unauthenticated requests
  userEmail String?
  details   Json?    // Event-specific details
  createdAt DateTime @default(now())

  @@index([type])
  @@index([ip])
  @@index([userId])
  @@index([createdAt])
  @@index([severity])
}

// === PLATFORM SETTINGS ===
// Dynamic configuration that can be changed from admin panel
model PlatformSetting {
  id        String   @id @default(uuid())
  category  String   // 'ai', 'api', 'features', etc.
  key       String   // 'limits.free', 'enabled', etc.
  value     String   // JSON serialized value
  updatedBy String?  // Admin user ID who last updated
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([category, key])
  @@index([category])
}
